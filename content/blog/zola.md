+++
title = "Porting my blog to Zola"
date = "2022-06-17"
+++

## Moving away from Jekyll

anything is better than jekyll where installing the github-pages-compatible version requires ruby 2.7 (latest is 3.x) which i have to compile from source on some oses, and images have to be located away from articles

I searched for alternative engines. My first idea was hosting WordPress on a Pi running in my LAN, and exporting static sites to GitHub Pages to avoid the security nightmare of exposing WordPress plugins to hackers. But the Gutenberg editor proved to be a buggy trainwreck for editing blog posts, and many of my cursor movement/editing bug reports were ignored. (Interestingly, Gutenberg is placing some effort in editing *web design site* layouts rather than *article content*.) The classic HTML-based editor was more workable, but was prone to producing inconsistent styling from pasted HTML. And many WordPress themes were highly commercialized or built for storefronts rather than blogs, and some noncommercial themes had translation errors from another language or were missing ids for each header. I eventually abandoned trying to migrate my blog posts to WordPress and writing new articles in it.

Hugo was an option, and GitLab Pages offered it as an example. However from my initial (incomplete) research, I found that Hugo stored images globally like Jekyll (making it harder to bundle images with an article), rather than next to articles. This has been fixed in Hugo 0.32 ([link](https://gohugo.io/news/0.32-relnotes/)) and documented at <https://gohugo.io/content-management/image-processing/> and <https://gohugo.io/content-management/organization/>, but I must've missed it when doing my research.

I had difficulty setting up a Zola project and picking a theme. I ran through the [Zola themes page](https://www.getzola.org/themes/) trying to pick a theme I liked. While most theme demos included syntax-highlighted code blocks without needing JS (since this is a core Zola feature), some themes had their layout break with JS turned off, and some appeared abandoned. Additionally Zola required manual setup to get a demo site up and running, and I didn't know how to do it since each theme expects a different layout of Markdown files (for history/archives, About pages, and posts).

In the end, I deferred actually porting my site off Jekyll for a few months (*nervous laughter*), and only returned to it once I tried writing [my latest blog post](@/blog/low-latency-audio-output-duplex-alsa.md) on an old laptop I revived with Void Linux, and couldn't install the Jekyll version required by GitHub Pages because it required Ruby 2, which I had to compile from scratch... on a laptop Core 2 Duo...

## The rewrite

Around that time I had encountered ["Arc and Mutex in Rust"](https://itsallaboutthebit.com/arc-mutex/), and was struck by its typography. Once I finished publishing my blog post, I download Tale-Zola to my Zola project, setup the sample site (by copying sample posts from the theme into my site), and began changing theme layouts, discovering and fixing invalid HTML generated by the theme, replacing fonts, increasing font contrast, improving spacing, adding visited link colors, cursing out CSS specificity rules...

I struggled to learn Zola at first, specifically piecing together the relationship between index.md, \_index.md, and pages in my site, and templates like index.html, section.html, and page.html in the theme, was unclear, since sections and pages each have a "hidden" (convention over configuration) default template name which can be overridden by parent sections or the .md file itself. I couldn't figure out what template was used for each section or page by reading the sample site alone; it was *very confusing* to remove individual templates and watch the build break as Zola tried to reference missing template names never referenced in my entire site. I was also overwhelmed by the search results for `zola page.html` and similar. In the end, I managed to partly figure out the template names and continue working on my site, before taking a break to read the docs fully (which *did* explain the template names).

I would much rather require the project configuration to explicitly spell out which template is used for the site root, sections, and pages, so I can ***grep*** my project for template names like index.html and find a configuration line telling me which content files correspond to that template. (See [discussion on this topic](https://softwareengineering.stackexchange.com/questions/165649/is-convention-over-configuration-not-violating-basic-programming-principles).)

TODO

<!-- The relationship between index.md, \_index.md, and pages in my site, and section.html and page.html (and alternative template names) in the theme, was unclear. Since Googling for help didn't work well, I had to read through the docs from front to back to learn how the HTML files were organized. --> The docs were comprehensive and fairly clear, but the material was dense, and I had to consciously read, take notes, and stop reading whenever I found myself glazing over the pages. In any case, I now better know how to work with Zola, though I probably wouldn't be able to write a site config or theme from scratch.

I removed comments because nobody used them anyway ;) and I didn't take the time to redo the Utterances integration.

## Porting my content

markdown is a "great" format (dripping sarcasm). Every blog engine interprets it slightly differently, so unless you check every page or normalize all pages before importing to a different engine, you're guaranteed to break old blog posts. In my case, I had to unindent some bullet points in a footnote, which Zola interpreted as an indented code block.

In Jekyll, I had used custom `_includes` HTML files to act as a template for images with captions. I ported this to Zola's shortcode system, which was quite simple once I figured out it was called a shortcode.

Zola is a *lot* pickier about date formats than Jekyll, requiring either `yyyy-mm-dd` or `yyyy-mm-ddThh:mm:ssÂ±hh:mm`, and rejecting other date formats. It took me a while to figure *this* one out, before I had read the docs and found the valid date format. Interestingly, bare `yyyy-mm-dd` dates always record a timezone of +00:00 in the Open Graph and JSON-LD metadata. I wonder if this is a good or bad thing, or if it doesn't matter at all.

## Hosting

You *can* run Zola on GitHub Pages ([docs](https://www.getzola.org/documentation/deployment/github-pages/))... but you need to use a GitHub action ([link](https://github.com/shalzz/zola-deploy-action)) which force-pushes a single commit with compiled output to the `gh-pages` branch every time you push new data to a source branch. Strangely, the Zola docs say to create a personal access token and assign it to the `TOKEN` environment variable, whereas the action docs say to specify `GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}` (`secrets.GITHUB_TOKEN` is created by GitHub on every job).

TODO

Interestingly, the unofficial [GitHub Pages action](https://github.com/marketplace/actions/github-pages-action) doesn't need a personal access token, but can use `GITHUB_TOKEN`, a job-local token ([link](https://docs.github.com/en/actions/security-guides/automatic-token-authentication)), with some limitations ([link](https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-first-deployment-with-github_token)).

The zola-deploy-action script fails to create a `.nojekyll` file, unlike the github-pages-action script. This probably slows down deploying the resulting static site.

GitLab doesn't require setting up an access token, and abstracts over the process (doesn't expose the generated html as a branch). I decided to host on GitLab pages, but may reconsider this decision.

## Conclusion

Zola is a good engine. The docs were quite comprehensive (though I did come across one piece of outdated information, which I [contributed a pull request to fix](https://github.com/getzola/zola/pull/1901)).

The command line is *blazing fast*: it builds my entire blog in around 40-50 ms and rebuilds in 20-30 ms on my Ryzen 5 5600X desktop, and rebuilds in around 1 second on my aging Core 2 Duo laptop running Void Linux on a mechanical drive.

<!-- ## The result -->

Outside of my learning pains, I'm very satisfied with rewriting my blog in Zola. I hope it will continue to be maintained and grow with my site. I sure hope that Arch, Void, and Alpine won't start shipping incompatible Zola versions...
